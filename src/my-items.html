<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-items">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        height: 100%;
      }
      .item{
        height: 40px;
        padding: 0 16px;
        border-bottom: 1px solid rgba(0,0,0,0.07);
        border-left: 1px solid rgba(0,0,0,0.07);
        border-right: 1px solid rgba(0,0,0,0.07);
      }
      .item:hover{
        background-color: rgba(0,0,0,0.02);
      }
      .item>div{
        flex: 0 0 auto;
      }
      .item img{
        width: 32px;
        height: 32px;
      }

      iron-list{
        flex: 1 1 auto;
        background-color: white;
        width: 1190px;
      }
      .header{
        flex: 0 0 auto;
        background-color: white;
        border: 1px solid rgba(0,0,0,0.07);
        width: 1157px;
        margin-top: 48px;
        font-weight: bold;
        text-align: center;
      }

      .level{
        color: white;
        font-weight: bold;
        text-align: center;
        text-shadow:
          -1px -1px 1px #000,
           1px -1px 1px #000,
          -1px 1px 1px #000,
           1px 1px 1px #000;
        width: 40px; 
        height: 32px;
        background-image: url('http://sols9.com/shopheroes/assets/icon/level_blue.png');
        background-position: 50% 50%;
        background-size: contain;
        background-repeat: no-repeat;
        line-height: 2;
      }

      .image{
        width: 40px;
        height: 32px;
        background-position: 50% 50%;
        background-size: contain;
        background-repeat: no-repeat;
      }
      
      .price{
        width: 88px; 
        text-align: right;
        background-image: url('http://sols9.com/shopheroes/assets/icon/gold.png');
        background-position: 100% 0;
        background-size: contain;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      .small{
        font-size: 12px;
        color: rgba(0,0,0,0.57);
      }

      .power{
        width: 56px;
        text-align: right;
        background-image: url('http://sols9.com/shopheroes/assets/icon/power.png');
        background-position: 100% 0;
        background-size: contain;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      .time{
        width: 96px;
        text-align: right;
        background-image: url('http://sols9.com/shopheroes/assets/icon/time.png');
        background-position: 100% 0;
        background-size: contain;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      #filterDialog{
        width: 80%;
        min-width: 298px;
        max-width: 698px;
      }
      #filterDialog>paper-dialog-scrollable{
        --paper-dialog-scrollable:{
          padding: 0;
        };
      }
      .filter-line{
        padding: 8px 24px;
        border-bottom: 1px solid rgba(0,0,0,0.07);
      }
      .filter-line .subheader{
        font-weight: bold;
        color: rgba(0,0,0,0.54);
      }
      .item-class{
        width: 44px; height: 44px;
        background-color: rgba(0,0,0,0.17);
        border: 1px solid rgba(0,0,0,0.17);
        cursor: pointer;
        opacity: 0.37;
        margin: 2px;
        border-radius: 16px;
      }
      .item-class>img{
        width: 100%; height: 100%;
      }
      .item-class.iron-selected{
        opacity: 1;
      }

      #skillDialog{
        width: 80%;
        min-width: 328px;
        max-width: 888px;
      }
      .skill-class{
        width: 64px;
        height: 100%;
        border: 1px solid rgba(0,0,0,0.07);
        text-align: center;
        overflow: hidden;
        margin: 2px;
      }
      .skill-class>img{
        width: 64px;;
        height: 66px;
        margin-bottom: -32px;
      }
      .skill-class>paper-input{
        width: 48px;
        margin: 0 auto;
      }
    </style>

    <iron-ajax auto url="/json/items.json" handle-as="json" 
      debounce-duration="300" last-response="{{itemdata}}" on-response="_filterChanged"></iron-ajax>

      <div class="header item layout horizontal center">
        <div style="width: 72px;">
          <paper-icon-button icon="filter-list" on-tap="openFilterDialog"></paper-icon-button>
        </div>
        <!--<div style="width: 40px;">LV</div>-->
        <div style="width: 220px; text-align: left;">
          <paper-input label="Search" value="{{query}}" style="height: 97px; width: 180px; margin: 0 0 0 40px;">
            <paper-icon-button suffix icon="close" style="color: rgba(0,0,0,0.37);" on-tap="clearQuery"></paper-icon-button>
          </paper-input>
        </div>
        <div style="width: 114px;"></div>
        <div style="width: 104px;"></div>
        <div style="width: 82px;"></div>
        <div style="width: 122px;">TIME
          <paper-icon-button icon="settings" on-tap="openSkillDialog"></paper-icon-button>
        </div>
        <div style="width: 296px;"></div>
        <div style="width: 160px;"></div>
      </div>
      
      <iron-list id="list" items="[[items]]" max-physical-count="100">
        <template>
          <div class="item layout horizontal center">
            <div style="width: 32px; height: 32px;"><img src="{{assetUrl(item.class,'type')}}" alt="{{item.class}}"></div>
            <div style="width: 32px; height: 32px;">
              <template is="dom-if" if="{{isChest(item.source)}}">
                <img src="{{assetUrl(item.source,'chest')}}" alt="{{item.class}}">
                <paper-tooltip position="top" offset="2">{{item.source}}</paper-tooltip>
              </template>
            </div>
            <div class="level">{{item.level}}</div>
            <div class="image" style="{{getImageStyle(item)}}"></div>
            <div style="width: 180px;">{{item.name}}</div>
            <div class="price">{{formatNumber(item.gold)}}</div>
            <div style="width: 104px; text-align: right;">{{formatNumber(item.exp)}} <span class="small">EXP</span></div>
            <div class="power">{{formatNumber(item.power)}}</div>
            <div class="time">{{formatCraftTime(skills.*, item.skills)}}</div>
            <div style="width: 280px;">
              <sh-ressource ressources="{{item.ressources}}"></sh-ressource>
            </div>
            <div style="width: 160px;" class="layout horizontal">
              <template is="dom-if" if="{{!isEmpty(item.artifacts)}}">
                <sh-artifact class="chip layout horizontal center" artifacts="{{item.artifacts}}"></sh-artifact>&nbsp;
              </template>
              <template is="dom-if" if="{{!isEmpty(item.precrafts)}}">
                <sh-precraft class="chip layout horizontal center" precrafts="{{item.precrafts}}"></sh-precraft>
              </template>
            </div>
          </div>
        </template>
      </iron-list>
      
      <paper-dialog id="filterDialog">
        <h2>Item Filters</h2>
        <paper-dialog-scrollable>
          <div class="filter-line" style="border-top: 1px solid rgba(0,0,0,0.07)">
            <div class="subheader" style="margin: 8px 0 26px 0;">Item Level</div>
            <paper-range-slider always-show-pin pin step='1' min='1' max='50' 
            value-min='{{minlv}}' value-max='{{maxlv}}' style="width: 100%;"></paper-range-slider>
          </div>

          <div class="filter-line">
            <div style="height: 40px;">
              <span class="subheader">Item Class</span>
              <paper-button raised style="height: 28px;" on-tap="setClassesAll">Select All</paper-button>
              <paper-button raised style="height: 28px;" on-tap="setClassesNone">Clear</paper-button>
            </div>
            <iron-selector attr-for-selected="name" multi selected-values="{{classes}}" class="layout horizontal wrap">
              <template is="dom-repeat" items="{{allclasses}}">
                <div name="{{item}}" class="item-class" style$="{{classStyle(item)}}" on-tap="classTap">
                  <img src="{{assetUrl(item,'type')}}" alt="{{item}}">
                  <paper-tooltip position="top" offset="2">{{item}}</paper-tooltip>
                </div>
              </template>
            </iron-selector>
          </div>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-confirm autofocus on-tap="_filterChanged">OK</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog id="skillDialog">
        <h2>Enter your skills to get the correct crafting time</h2>
        <paper-dialog-scrollable>
          <div class="layout horizontal wrap">
          <template is="dom-repeat" items="{{skills}}">
            <div name="{{item}}" class="skill-class layout vertical">
              <img src="{{assetUrl(index,'skill')}}" alt="{{item}}">
              <paper-input label="" allowed-pattern="[0-9]" value="{{item}}"></paper-input>
              <paper-tooltip position="top" offset="2">{{getSkillName(index)}}</paper-tooltip>
            </div>
          </template>
          </div>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-confirm autofocus on-tap="_filterChanged">OK</paper-button>
        </div>
      </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'my-items',
      properties: {
        query: {
          type: String,
          value: "",
          observer: "_queryChanged"
        },
        search: {
          type: String,
          value: "",
          observer: "_filterChanged"
        },
        maxlv: {
          type: Number,
          value: 50
        },
        minlv: {
          type: Number,
          value: 0
        },
        classes: {
          type: Array,
          value: function() {
            return ['Swords', 'Daggers', 'Axes', 'Spears',  
            'Armor', 'Vests', 'Helmets', 'Gauntlets', 'Boots', 
            'Remedies', 'Potions',
            'Rings', 'Pendants',
            'Maces', 'Staves', 'Bows', 'Guns',
            'Clothes', 'Shields', 'Hats', 'Bracers', 'Footwear', 
            'Spells', 'Projectiles', 'Instruments'];
          }
        },
        allclasses: {
          type: Array,
          value: function() {
            return ['Swords', 'Daggers', 'Axes', 'Spears',  
            'Armor', 'Vests', 'Helmets', 'Gauntlets', 'Boots', 
            'Remedies', 'Potions',
            'Rings', 'Pendants',
            'Maces', 'Staves', 'Bows', 'Guns',
            'Clothes', 'Shields', 'Hats', 'Bracers', 'Footwear', 
            'Spells', 'Projectiles', 'Instruments'];
          }
        },
        skills: {
          type: Array,
          value: function() {
            return [100,100,100,100,100,100,100,100,100,100,100,100];
          },
          notify: true
        },
        skillName: {
          type: Array,
          value: function() {
            return ['Metal Working', 'Wood Working', 'Textile Working', 'Alchemy', 'Magic', 
            'Weapon Crafting', 'Armor Making', 'Arts and Crafts', 'Jewelry', 'Rune Writing', 'Tinkering', 'Mastery'];
          }
        },
        itemdata: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },
      _queryChanged: function(){
        this.debounce('queryChanged', function() {
          this.set('search', this.query.trim());
        }, 300);
      },
      _filterChanged: function(){
        if(this.itemdata==undefined) return;
        this.set('items', this.filterItems());
        //console.log('_filterChanged', this.items.length, this.$.list._physicalCount);
      },
      filterItems: function(){
        return this.itemdata.filter(function (item) {
          if(item.level < this.minlv) return false;
          if(item.level > this.maxlv) return false;
          if(this.classes!=undefined && this.classes.indexOf(item.class)==-1) return false;

          if(this.query.length>2){
            var re = new RegExp(this.query, 'i');
            if(!re.test(item.name)) return false;
          }
          return true;
        }.bind(this));
      },
      clearQuery: function(){
        this.set('query', "");
      },
      openFilterDialog: function(){
        this.$.filterDialog.open();
      },
      setClassesAll: function(){
        this.set('classes', ['Swords', 'Daggers', 'Axes', 'Spears', 'Maces', 'Staves', 'Bows', 'Guns', 
            'Armor', 'Vests', 'Helmets', 'Gauntlets', 'Boots', 
            'Clothes', 'Shields', 'Hats', 'Bracers', 'Footwear', 
            'Remedies', 'Potions', 'Spells', 'Projectiles', 'Rings', 'Pendants', 'Instruments']);
      },
      setClassesNone: function(){
        this.set('classes', []);
      },
      classTap: function(e){
        console.log(e.model);
        if(this.classes.length==25){
          this.set('classes', [e.model.item]);
          e.stopPropagation();
        }else if(this.classes.length==1 && this.classes[0]==e.model.item){
          this.setClassesAll();
          e.stopPropagation();
        }
      },
      classStyle: function(t){
        switch (t) {
          case "Swords":
          case "Daggers":
          case "Axes":
          case "Spears":
          case "Maces":
          case "Staves":
          case "Bows":
          case "Guns":
            return "background-color: rgba(202,49,49,1);";
          case "Remedies":
          case "Potions":
          case "Spells":
          case "Projectiles":
            return "background-color: rgba(39,198,140,1);";
          case "Rings":
          case "Pendants":
          case "Instruments":
            return "background-color: rgba(255,211,93,1);";
          default:
            return "background-color: rgba(9,182,240,1);";
        }
      },
      openSkillDialog: function(){
        this.$.skillDialog.open();
      },
      getSkillName: function(i){
        return this.skillName[i];
      },
      assetUrl: function(i,t){
        switch (t) {
          case "type":
            return "https://cdn.rawgit.com/ShopHeroesData/datahub-shopheroes/master/src/assets/ItemIcons/"+i+".png";
          case "skill":
            var n = this.skillName[i].toLowerCase().replace(/ /gi, "");
            return "https://cdn.rawgit.com/ShopHeroesData/datahub-shopheroes/master/src/assets/SkillIcons/"+n+".png";
          case "chest":
            return "http://sols9.com/shopheroes/assets/chest/"+i+".png";
          default:
            return "";
        }
      },
      getImageStyle: function(i){
        return "background-image: url('http://sols9.com/shopheroes/assets/ItemImages/?n="+i.id+"');";
      },
      formatNumber: function(n){
        return n.toLocaleString();
      },
      getCraftTime: function(change, item){
        var m = 0;
        for(i in item){
          if(item[i] > 0){
            if(this.skills[i]>0){
              m += item[i]/this.skills[i];
            }else{
              return 0;
            }
          }
        }
        return Math.ceil(m*60);
      },
      formatTime: function(sec){
        sec = parseInt(sec, 10);
        if(sec<=0) return "-";

        var h   = Math.floor(sec / 3600);
        var m = Math.floor((sec - (h * 3600)) / 60);
        var s = sec - (h * 3600) - (m * 60);

        var r="";
        if(h>0){
          if (m < 10) {m = "0"+m;}
          if (s < 10) {s = "0"+s;}
          return h+"h"+m+"m"+s+"s";
        }
        if(m>0){
          if (s < 10) {s = "0"+s;}
          return m+"m"+s+"s";
        }
        if(s>0){
          return s+"s";
        }
        return "N/A";
        //return h+"h"+m+"m"+s+"s";
      },
      formatCraftTime: function(item,setting){
        var t = this.getCraftTime(item,setting);
        return this.formatTime(t);
      },
      isEmpty: function(a){
        return a.length==0;
      },
      isChest: function(s){
        return s!="---";
      }
    });
  </script>
</dom-module>
