<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-items">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        height: 100%;
      }
      .item{
        height: 40px;
        border-bottom: 1px solid rgba(0,0,0,0.07);
        min-width: 100%;
        width: auto !important;
      }
      .item:hover{
        background-color: rgba(0,0,0,0.02);
      }
      .item>div{
        flex: 0 0 auto;
      }
      .item iron-image{
        background-color: var(--app-background-color);
      }

      .header{
        flex: 0 0 auto;
        height: 40px;
        background-color: var(--paper-grey-100);
        border-bottom: 1px solid rgba(0,0,0,0.07);
        margin-top: 48px;
        font-weight: bold;
        text-align: center;
        width: 100%;
        max-width: 1420px;
      }

      #list{
        flex: 1 1 auto;
        width: 100%;
        background-color: var(--app-background-color);
        max-width: 1420px;
      }

      .class-div{
        width: 32px; height: 32px;
        text-align: right;
      }
      .level{
        color: white;
        font-weight: bold;
        text-align: center;
        text-shadow:
          -1px -1px 1px #000,
           1px -1px 1px #000,
          -1px 1px 1px #000,
           1px 1px 1px #000;
        width: 32px; 
        height: 32px;
        background-image: url('http://sols9.com/shopheroes/assets/icon/level_blue.png');
        background-position: 50% 50%;
        background-size: contain;
        background-repeat: no-repeat;
        line-height: 2;
      }

      .image{
        width: 48px;
        height: 39px;
        background-position: 0% 50%;
        background-size: contain;
        background-repeat: no-repeat;
      }
      
      .price{
        width: 96px; 
        text-align: right;
        background-image: url('http://sols9.com/shopheroes/assets/icon/gold.png');
        background-position: 100% 0;
        background-size: contain;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      .small{
        font-size: 12px;
        color: rgba(0,0,0,0.57);
      }

      .power{
        width: 56px;
        text-align: right;
        background-image: url('http://sols9.com/shopheroes/assets/icon/power.png');
        background-position: 100% 0;
        background-size: contain;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      .time{
        width: 96px;
        text-align: right;
        background-image: url('http://sols9.com/shopheroes/assets/icon/time.png');
        background-position: 100% 0;
        background-size: contain;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      .field{
        padding-right: 4px;
      }

      #filterDialog{
        max-width: 715px;
        margin: 64px 0 16px 0;
      }
      #filterDialog>paper-dialog-scrollable{
        --paper-dialog-scrollable:{
          padding: 0;
        };
      }
      .filter-line{
        padding: 8px 24px;
        border-bottom: 1px solid rgba(0,0,0,0.07);
      }
      .filter-line .subheader{
        font-weight: bold;
        color: rgba(0,0,0,0.54);
      }
      .item-class{
        width: 44px; height: 44px;
        background-color: rgba(0,0,0,0.17);
        border: 1px solid rgba(0,0,0,0.17);
        cursor: pointer;
        opacity: 0.37;
        margin: 2px;
        border-radius: 16px;
      }
      .item-class>img{
        width: 100%; height: 100%;
      }
      .item-class.iron-selected{
        opacity: 1;
      }

      .item-chest{
        width: 88px; height: 88px;
        background-color: rgba(0,0,0,0.17);
        border: 1px solid rgba(0,0,0,0.17);
        cursor: pointer;
        opacity: 0.37;
        margin: 1px;
        border-radius: 3px;
        text-align: center;
        position: relative;
      }
      .item-chest>iron-image{
        height: 100%; width: 100%;
      }
      .item-chest.iron-selected{
        opacity: 1;
      }

      .item-chest-name{
        position: absolute;
        bottom: 0;
        width: 100%;
        background-color: rgba(0,0,0,0.37);
        min-height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .item-precraft{
        cursor: pointer;
        background-color: rgba(0,0,0,0.07);
        border: 1px solid rgba(0,0,0,0.17);
        padding: 4px;
        margin: 2px;
        border-radius: 3px;
        width: 64px;
        text-align: center;
        opacity: 0.37;
      }
      .item-precraft.iron-selected{
        opacity: 1;
      }

      #skillDialog{
        margin: 64px 0 16px 0;
        max-width: 888px;
      }
      .skill-class{
        width: 64px;
        height: 100%;
        border: 1px solid rgba(0,0,0,0.07);
        text-align: center;
        overflow: hidden;
        margin: 2px;
      }
      .skill-class>iron-image{
        width: 64px;;
        height: 66px;
        margin-bottom: -32px;
      }
      .skill-class>paper-input{
        width: 48px;
        margin: 0 auto;
      }

      .mskill{
        font-weight: bold;
        size: 14px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        padding-left: 6px;
        text-shadow:
          -1px -1px 1px #000,
           1px -1px 1px #000,
          -1px 1px 1px #000,
           1px 1px 1px #000;
      }

      #sortDialog{
        margin: 64px 0 16px 0;
      }
      .sort-option{
        height: 32px;
        width: 100%;
        min-width: 80px;
        cursor: pointer;
        background-color: rgba(0,0,0,0.07);
        border: 1px solid rgba(0,0,0,0.17);
        padding: 4px 16px;
        margin: 2px;
        text-align: center;
        opacity: 0.5;
      }
      .sort-option.iron-selected{
        opacity: 1;
        background-color: rgba(0,0,0,0.07);
        border: 1px solid rgba(0,0,0,0.37);
      }
      .sort-name{
        margin-left: 16px;
      }
    </style>

      <div class="header layout horizontal center">
        <div style="width: 112px; flex: 0 1 auto;">
          <paper-icon-button icon="filter-list" on-tap="openFilterDialog" title="Filter Items"></paper-icon-button>
          <paper-icon-button icon="sort" on-tap="openSortDialog" title="Sort Items"></paper-icon-button>
        </div>
        <div style="max-width: 220px; text-align: left;">
          <paper-input label="Search" value="{{query}}" style="height: 97px; max-width: 180px;">
            <paper-icon-button suffix icon="close" style="color: rgba(0,0,0,0.37);" on-tap="clearQuery"></paper-icon-button>
          </paper-input>
        </div>
        <div class="layout horizontal center center-justified flex" style="white-space: nowrap;">
          <div>TIME</div>
          <paper-icon-button icon="settings" on-tap="openSkillDialog"></paper-icon-button>
        </div>
      </div>
      
      <iron-list id="list" items="[[items]]" max-physical-count="100">
        <template>
          <div class="item layout horizontal center">
            <div style="width: 32px; height: 32px; margin-left: 4px;">
              <template is="dom-if" if="{{isChest(item.source)}}">
                <iron-image src="http://sh-api.sols9.com/images/packs/{{item.source}}.png" class="wh32" sizing="contain" alt="{{item.source}}" title="{{item.source}}" preload fade></iron-image>
                <!--<paper-tooltip position="top" offset="2">{{item.source}}</paper-tooltip>-->
              </template>
            </div>
            <div class="class-div">
              <iron-image src="{{assetUrl(item.class,'type')}}" class="wh32" sizing="contain" alt="{{item.class}}" title="{{item.class}}" preload fade></iron-image>
              <!--<paper-tooltip position="top" offset="2">{{item.class}}</paper-tooltip>-->
            </div>
            <div class="level">{{item.level}}</div>
            <a href="/craft/{{item.name}}" class="nolink layout horizontal center">
              <iron-image class="image" src="http://sh-api.sols9.com/images/craft_icon/{{item.name}}.png" sizing="contain" alt="{{item.name}}" preload fade></iron-image>
              <div style="width: 180px;">{{item.name}}</div>
            </a>
            <div class="price">{{formatNumber(item.gold)}}</div>
            <div style="width: 116px; text-align: right;">{{formatNumber(item.exp)}} <span class="small">EXP</span></div>

            <div class="layout horizontal center" style="width: 104px; text-align: right;" hidden$="{{!isEqual(sort,'exp-gold')}}"> 
              <div class="flex field">{{expPerGold(item)}}</div>
              <span class="w24 small">EXP</span>
              <div>/</div>
              <iron-image class="wh24" sizing="contain" src="http://sh-api.sols9.com/images/icon/gold.png"></iron-image>
            </div>

            
            <div class="time">{{formatCraftTime(user.skills.*, item.skills)}}</div>

            <div class="layout horizontal center" style="width: 144px; text-align: right;" hidden$="{{!isEqual(sort,'gold-time')}}"> 
              <div class="flex field">{{goldPerSec(item, user.skills.*)}}</div>
              <iron-image class="wh24" sizing="contain" src="http://sh-api.sols9.com/images/icon/gold.png"></iron-image>
              <div>/</div>
              <span class="w24 small">SEC</span>
            </div>
            <div class="layout horizontal center" style="width: 144px; text-align: right;" hidden$="{{!isEqual(sort,'exp-time')}}"> 
              <div class="flex field">{{expPerSec(item, user.skills.*)}}</div>
              <span class="w24 small">EXP</span>
              <div>/</div>
              <span class="w24 small">SEC</span>
            </div>

            <div style="width: 120px;">
              <sh-componentfor craft="{{item}}" class="layout horizontal center"></sh-componentfor>
            </div>

            <div class="power">{{formatNumber(item.power)}}</div>
            <div style="width: 108px;">
              <template is="dom-if" if="{{isSkill(item)}}">
                <div class="mskill" tquality$="{{item.progression.4.quality}}" title="{{item.progression.4.value}} @ {{item.progression.4.quality}}">{{item.progression.4.value}}</div>
                <!--<paper-tooltip position="top" offset="2">{{item.mskill}} @ {{item.mquality}}</paper-tooltip>-->
              </template>
            </div>
            <div style="width: 128px;" class="layout horizontal">
              <template is="dom-if" if="{{!isEmpty(item.artifacts)}}">
                <sh-artifact class="chip layout horizontal center" artifacts="{{item.artifacts}}"></sh-artifact>&nbsp;
              </template>
              <template is="dom-if" if="{{!isEmpty(item.precrafts)}}">
                <sh-precraft class="chip layout horizontal center" precrafts="{{item.precrafts}}"></sh-precraft>
              </template>
            </div>
            <div style="width: 272px;">
              <sh-ressource ressources="{{item.ressources}}"></sh-ressource>
            </div>
          </div>
        </template>
      </iron-list>
      
      <paper-dialog id="filterDialog">
        <h2>Item Filters</h2>
        <paper-dialog-scrollable>
          <div class="filter-line" style="border-top: 1px solid rgba(0,0,0,0.07)">
            <div class="subheader" style="margin: 8px 0 26px 0;">Item Level</div>
            <paper-range-slider always-show-pin pin step='1' min='1' max='60' 
            value-min='{{minlv}}' value-max='{{maxlv}}' style="width: 100%;"></paper-range-slider>
          </div>

          <div class="filter-line">
            <div style="height: 40px;">
              <span class="subheader">Item Class</span>
              <paper-button raised style="height: 28px;" on-tap="setClassesAll">Select All</paper-button>
              <paper-button raised style="height: 28px;" on-tap="setClassesNone">Clear</paper-button>
            </div>
            <iron-selector attr-for-selected="name" multi selected-values="{{classes}}" class="layout horizontal wrap">
              <template is="dom-repeat" items="{{allclasses}}">
                <div name="{{item}}" class="item-class" style$="{{classStyle(item)}}" on-tap="classTap">
                  <img src="{{assetUrl(item,'type')}}" alt="{{item}}">
                  <paper-tooltip position="top" offset="2" animation-delay="0">{{item}}</paper-tooltip>
                </div>
              </template>
            </iron-selector>
          </div>

          <div class="filter-line">
            <div style="height: 40px;">
              <span class="subheader">Chests and Packages</span>
              <paper-button raised style="height: 28px;" on-tap="setChestsAll">Select All</paper-button>
              <paper-button raised style="height: 28px;" on-tap="setChestsNone">Clear</paper-button>
            </div>
            <iron-selector attr-for-selected="name" multi selected-values="{{chests}}" class="layout horizontal wrap">
              <template is="dom-repeat" items="{{allchests}}">
                <div name="{{item}}" class="item-chest" style$="{{chestStyle(item)}}" on-tap="chestTap">
                  <iron-image src="http://sh-api.sols9.com/images/packs/{{item}}.png" sizing="contain" alt="{{item}}" preload fade></iron-image>
                  <div class="item-chest-name" tquality="Common">{{item}}</div>
                </div>
              </template>
            </iron-selector>
          </div>

          <div class="filter-line">
            <div>
              <span class="subheader">Precrafts</span>
            </div>
            <p>Include items that have precrafts of the following qualities: </p>
            <iron-selector attr-for-selected="name" multi selected-values="{{precrafts}}" class="layout horizontal wrap">
              <template is="dom-repeat" items='["Common", "Good", "Great", "Flawless"]'>
                <div name="{{item}}" class="item-precraft" tquality$="{{item}}">{{item}}</div>
              </template>
            </iron-selector>
          </div>

          <div class="filter-line">
            <div>
              <span class="subheader">Mastery Skill</span>
            </div>
            <p>To filter by skill, type the name of the skill (Energetic) into the item search box at the top left of the item table.</p>
          </div>

        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-confirm autofocus on-tap="filterChanged">OK</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog id="sortDialog">
        <h2>Sort Items by</h2>
        <paper-dialog-scrollable>
          
          <iron-selector attr-for-selected="name" selected="{{sort}}" class="layout vertical center">
            <div name="none" class="layout horizontal center sort-option">
              <iron-icon icon="block" class="wh32"></iron-icon>
              <div class="sort-name">No sorting</div>
            </div>
            <div name="level" class="layout horizontal center sort-option">
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/level_blue.png"></iron-image>
              <div class="sort-name">Level</div>
            </div>
            <div name="gold" class="layout horizontal center sort-option">
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/gold.png"></iron-image>
              <div class="sort-name">Gold</div>
            </div>
            <div name="power" class="layout horizontal center sort-option">
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/power.png"></iron-image>
              <div class="sort-name">Power</div>
            </div>
            <div name="exp" class="layout horizontal center sort-option">
              <div class="wh32 layout horizontal center" style="text-align: center;">EXP</div>
              <div class="sort-name">Experience</div>
            </div>
            <div name="time" class="layout horizontal center sort-option">
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/time.png"></iron-image>
              <div class="sort-name">Crafting Time</div>
            </div>
            <div name="gold-time" class="layout horizontal center sort-option">
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/gold.png"></iron-image>
              <div style="margin: 0 4px; font-size: 28px;">/</div>
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/time.png"></iron-image>
              <div class="sort-name">Gold per Second</div>
            </div>
            <div name="exp-time" class="layout horizontal center sort-option">
              <div class="wh32 layout horizontal center" style="text-align: center;">EXP</div>
              <div style="margin: 0 4px; font-size: 28px;">/</div>
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/time.png"></iron-image>
              <div class="sort-name">Experience per Second</div>
            </div>
            <div name="exp-gold" class="layout horizontal center sort-option">
              <div class="wh32 layout horizontal center" style="text-align: center;">EXP</div>
              <div style="margin: 0 4px; font-size: 28px;">/</div>
              <iron-image class="wh32" sizing="contain" src="http://sh-api.sols9.com/images/icon/gold.png"></iron-image>
              <div class="sort-name">Experience per Gold</div>
            </div>
          </iron-selector>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-confirm autofocus on-tap="filterChanged">OK</paper-button>
        </div>
      </paper-dialog>
      
      <paper-dialog id="skillDialog">
        <h2>Crafting Skills</h2>
        <paper-dialog-scrollable>
          <div>Enter your skills to get the correct crafting time</div>
          <div class="layout horizontal wrap">
          <template is="dom-repeat" items="{{user.skills}}">
            <template is="dom-if" if="{{!isEqual(item.name, 'Mastery')}}">
            <div name="{{item}}" class="skill-class layout vertical">
              <iron-image src="http://sh-api.sols9.com/images/skill/{{item.name}}.png" sizing="contain" alt="{{item.name}}"></iron-image>
              <paper-input label="" allowed-pattern="[0-9]" value="{{item.value}}"></paper-input>
              <paper-tooltip position="top" offset="2" animation-delay="0">{{item.name}}</paper-tooltip>
            </div>
            </template>
          </template>
          </div>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-confirm autofocus on-tap="filterChanged">OK</paper-button>
        </div>
      </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'my-items',
      properties: {
        query: {
          type: String,
          value: "",
          observer: "_queryChanged"
        },
        search: {
          type: String,
          value: "",
          observer: "filterChanged"
        },
        maxlv: {
          type: Number,
          value: 55
        },
        minlv: {
          type: Number,
          value: 1
        },
        classes: {
          type: Array,
          value: function() {
            return ['Swords', 'Daggers', 'Axes', 'Spears',  
            'Armor', 'Vests', 'Helmets', 'Gauntlets', 'Boots', 
            'Remedies', 'Potions',
            'Rings', 'Pendants',
            'Maces', 'Staves', 'Bows', 'Guns',
            'Clothes', 'Shields', 'Hats', 'Bracers', 'Footwear', 
            'Spells', 'Projectiles', 'Instruments'];
          }
        },
        allclasses: {
          type: Array,
          value: function() {
            return ['Swords', 'Daggers', 'Axes', 'Spears',  
            'Armor', 'Vests', 'Helmets', 'Gauntlets', 'Boots', 
            'Remedies', 'Potions',
            'Rings', 'Pendants',
            'Maces', 'Staves', 'Bows', 'Guns',
            'Clothes', 'Shields', 'Hats', 'Bracers', 'Footwear', 
            'Spells', 'Projectiles', 'Instruments'];
          }
        },
        allchests: {
          type: Array,
          value: function() {
            return [
              '---','Wooden Chest','Leather Chest','Iron Chest','Golden Chest','Magic Chest','Dwarvish Chest','Primal Chest','City Raid',
              'Wizard Pack','Warrior Pack','Ninja Pack','Advanced Shopfare','Pack of all Trades'
            ];
          }
        },
        precrafts: {
          type: Array,
          value: function() {
            return ['Common','Good','Great','Flawless'];
          }
        },
        sort: {
          type: String,
          value: 'none'
        }
      },
      observers: [
        'itemsLoaded(crafts.splices)'
      ],
      ready: function(){

      },
      _queryChanged: function(){
        this.debounce('queryChanged', function() {
          this.set('search', this.query.trim());
        }, 300);
      },
      itemsLoaded: function(){
        var packs = [];
        for(var i in this.crafts){
          if(this.allchests.indexOf(this.crafts[i].source) == -1 ){
            packs.push(this.crafts[i].source);
          }
        }
        packs.sort(function(a, b) {
          return a.localeCompare(b);
        });

        for(var i in packs){
          if(this.allchests.indexOf(packs[i]) == -1 )
            this.push('allchests', packs[i]);
        } 
        this.set('chests', this.allchests);

        //console.log(this.allchests);
        this.filterChanged();
      },
      filterChanged: function(){
        //console.log(this.crafts);
        if(this.crafts==undefined) return;
        this.set('items', this.filterItems());
        //console.log('filterChanged', this.items.length, this.$.list._physicalCount);
      },
      filterItems: function(){
        var filtered =  this.crafts.filter(function (item) {
          if(item.level < this.minlv) return false;
          if(item.level > this.maxlv) return false;
          if(this.classes!=undefined && this.classes.indexOf(item.class)==-1) return false;
          if(this.chests!=undefined && this.chests.indexOf(item.source)==-1) return false;
          if(this.precrafts.length!=4){
            for(var i in item.precrafts){
              if(this.precrafts.indexOf(item.precrafts[i].quality) == -1) return false;
            }
          }

          if(this.query.length>2){
            var re = new RegExp(this.query, 'i');
            if(re.test(item.name)) return true;
            if(item.progression[4].type == 'skill' && re.test(item.progression[4].value)) return true;

            //var re2 = new RegExp('\\b'+this.query, 'i');
            //if(re2.test(item.source)) return true;
            //if('mskill' in item && re2.test(item.mskill)) return true;

            return false;
          }
          return true;
        }.bind(this));

        if(this.sort!='none'){
          filtered = filtered.sort(function(a,b){
            if(this.sort=='level'){
              return a.level-b.level;
            }else if(this.sort=='gold'){
              return b.gold-a.gold;
            }else if(this.sort=='exp'){
              return b.exp-a.exp;
            }else if(this.sort=='power'){
              return b.power-a.power;
            }else if(this.sort=='time'){
              return this.getCraftTime({},a.skills)-this.getCraftTime({},b.skills);
            }else if(this.sort=='gold-time'){
              var bt = this.getCraftTime({},b.skills);
              var at = this.getCraftTime({},a.skills);
              if(bt==0 && at==0) return 0;
              if(bt==0) return -1;
              if(at==0) return 1;
              return b.gold/bt-a.gold/at;
            }else if(this.sort=='exp-time'){
              var bt = this.getCraftTime({},b.skills);
              var at = this.getCraftTime({},a.skills);
              if(bt==0 && at==0) return 0;
              if(bt==0) return -1;
              if(at==0) return 1;
              return b.exp/bt-a.exp/at;
            }else if(this.sort=='exp-gold'){
              return b.exp/b.gold-a.exp/a.gold;
            }
          }.bind(this));
        }

        return filtered;
      },
      clearQuery: function(){
        this.set('query', "");
      },
      openFilterDialog: function(){
        this.$.filterDialog.open();
      },
      openSortDialog: function(){
        this.$.sortDialog.open();
      },
      setClassesAll: function(){
        this.set('classes', this.allclasses);
      },
      setClassesNone: function(){
        this.set('classes', []);
      },
      classTap: function(e){
        console.log(e.model);
        if(this.classes.length==25){
          this.set('classes', [e.model.item]);
          e.stopPropagation();
        }else if(this.classes.length==1 && this.classes[0]==e.model.item){
          this.setClassesAll();
          e.stopPropagation();
        }
      },
      classStyle: function(t){
        switch (t) {
          case "Swords":
          case "Daggers":
          case "Axes":
          case "Spears":
          case "Maces":
          case "Staves":
          case "Bows":
          case "Guns":
            return "background-color: rgba(202,49,49,1);";
          case "Remedies":
          case "Potions":
          case "Spells":
          case "Projectiles":
            return "background-color: rgba(39,198,140,1);";
          case "Rings":
          case "Pendants":
          case "Instruments":
            return "background-color: rgba(255,211,93,1);";
          default:
            return "background-color: rgba(9,182,240,1);";
        }
      },
      setChestsAll: function(){
        this.set('chests', this.allchests);
      },
      setChestsNone: function(){
        this.set('chests', []);
      },
      chestTap: function(e){
        if(this.chests.length==this.allchests.length){
          this.set('chests', [e.model.item]);
          e.stopPropagation();
        }else if(this.chests.length==1 && this.chests[0]==e.model.item){
          this.setChestsAll();
          e.stopPropagation();
        }
      },
      chestStyle: function(t){
        if(t.indexOf('Chest') !== -1) return "background-color: rgba(0,0,0,0.05);";
        return "background-color: rgba(0,0,0,0.03);";
      },
      openSkillDialog: function(){
        this.$.skillDialog.open();
      },
      assetUrl: function(i,t){
        switch (t) {
          case "type":
            return "https://cdn.rawgit.com/ShopHeroesData/datahub-shopheroes/master/src/assets/ItemIcons/"+i+".png";
          default:
            return "";
        }
      },
      formatNumber: function(n){
        return n.toLocaleString();
      },
      getCraftTime: function(change, item){
        var m = 0;
        for(i in item){
          if(item[i] > 0){
            if(this.user.skills[i].value>0){
              m += item[i]/this.user.skills[i].value;
            }else{
              return 0;
            }
          }
        }
        var s = Math.ceil(m*60);
        if(s<5) s=5;
        return s;
      },
      formatTime: function(sec){
        sec = parseInt(sec, 10);
        if(sec<=0) return "-";

        var h   = Math.floor(sec / 3600);
        var m = Math.floor((sec - (h * 3600)) / 60);
        var s = sec - (h * 3600) - (m * 60);

        var r="";
        if(h>0){
          if (m < 10) {m = "0"+m;}
          if (s < 10) {s = "0"+s;}
          return h+"h"+m+"m"+s+"s";
        }
        if(m>0){
          if (s < 10) {s = "0"+s;}
          return m+"m"+s+"s";
        }
        if(s>0){
          return s+"s";
        }
        return "N/A";
        //return h+"h"+m+"m"+s+"s";
      },
      formatCraftTime: function(item,setting){
        var t = this.getCraftTime(item,setting);
        return this.formatTime(t);
      },
      expPerGold: function(i){
        return (Math.round(i.exp/i.gold*1000)/1000).toFixed(3);
      },
      goldPerSec: function(i){
        var t = this.getCraftTime({},i.skills);
        if(t==0) return '-';
        return (Math.round(i.gold/t*10)/10).toFixed(1);
      },
      expPerSec: function(i){
        var t = this.getCraftTime({},i.skills);
        if(t==0) return '-';
        return (Math.round(i.exp/t*10)/10).toFixed(1);
      },
      isEmpty: function(a){
        return a.length==0;
      },
      isChest: function(s){
        return s!="---";
      },
      isSkill: function(i){
        return i.progression[4].type == 'skill';
      },
      isEqual: function(a,b){
        return a==b;
      }
    });
  </script>
</dom-module>
